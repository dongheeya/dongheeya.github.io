<h1>Chapter13.관리</h1>
<h2>13.1 독립 실행형 모드에서 멤버 시작</h2>
많은 유지보수 작업은 세컨더리에서 수행될 수 없으며, 애플리케이션 성능에 영향을 미치기 때문에 프라이머리에서 수행되면 안된다.
그래서 다음 절에서는 독립 실행형 모드 서버 시작을 자주 언급한다.

독립 실행형 모드에서 시작하려면 (1) 명령행 인수를 확인해야된다.

```
> db.serverCmdLineOpts()
{
  "argv" : [ "mongod","-f","/var/lib/mongod.conf"],
  "parsed":{
        "replSet":"mySet",
        "port":"27017",
        "dbpath":"/var/lib/db"
        },
  "ok" : 1
}
```
이 서버에서 유지보수를 수행하려면 replSet 옵션 없이 서버를 재시작하면된다.
일반적인 독립 실행형 mongod처럼 읽기와 쓰기가 가능하게 해준다.
복제 셋에 있는 다른 서버에서 이 서버와 토인하기를 원치 않으므로 서버가 다른 포트로 수신하게 된다.
마지막으로 서버 데이터를 조작하려고 이런 방식으로 시작하므로 dbpath는 그대로 유지한다.

1) 먼저 mongo 셸에서 서버를 종료한다.
```
> db.shutdownServer()
```
2) replSet 매개변수 없이 다른 포트에서 mongod를 시작한다
```
$ mongod --port 30000 --dbpath /var/lib/db
```

독립 실행형 서버로 구동되며 연결을 위한 포트는 30000번이다.
복제 셋의 다른 멤버는 27017번 포트로 이 서버에 접속을 시도하고, 곧 서버가 다운됐다고 추정하게 된다.

서버에서 유지보수 수행을 마치면, 서버를 종료하고 원래 옵션으로 재시작할 수 있다.

<h2>13.2 복제 셋 구성</h2>
복제셋 구성은 항상 local.system.replset 컬렉션의 도큐먼트에 보관된다.
이 도큐먼트는 복제 셋의 모든 멤버에서 같다.
절대 update를 이용해 도큐먼트를 변경하지 말자.
대신 항상 rs보조자나 replSetReconfig 명령을 사용하자

<h3>13.2.1 복제 셋 설정하기</h3>
멤버로 만들 mongod 들을 시작하고 그 중 하나에 rs.initiate()를 사용해 구성 정보를 전달함으로써 복제셋을 생성한다.
복제셋의 한 멤버에서만 rs.initiate를 호출할 수 있으며, 항상 config 객체를 rs.initiate에 전달해야한다.

<h3>13.3.2 복제 셋 멤버 교체하기</h3>
복제 셋에 새로운 멤버를 추라할 때는 데이터 디렉터리에 아무것도 존재하지 않거나 다른 멤버 데이터 복제본이 있어야한다.
프라이머리에 연결하고 다음처럼 새로운 멤버를 추가하자.

```
>rs.add("spock:27017")
```
더 복잡한 멤버 구성을 도큐먼트 형태로 명시한다.
```
>rs.add({"host":"spock:27017","priority":0, "hidden":true})
```
host필드를 이용해서 멤버를 제거할 수도 있다.
```
>rs.remove("spock:27017")
```

재구성을 통해 멤버의 설정을 바꿀 수 있다.
멤버의 설정을 바구는 데는 다음과 같은 제약사항이 있다.
- 멤버의 "_id"는 변경할 수 없다.
- 재구성 정보를 전달하려는 멤버(일반적으로 프라이머리)의 우선순위를 0으로 할 수 없다.
- 아비터에서 아비터가 아닌 것으로 변경할 수 없으며, 반대도 마찬가지다.
- 멤버의 "buildIndexes"를 false에서 true로 변경할 수 없다.

멤버의 "host"필드는 변경할 수 있다.
따라서 만약 호스트 정보를 잘못 명시했다면 나중에 간단히 구성을 변경해 올바른 IP로 정정할 수 있다.

호스트명을 변경하려면 다음과 같이 하면된다.
```
> var config = rs.config()
> config.members[0].host = "spock:27017"
> rs.reconfig(config)
```

<h3>13.2.3 큰 복제 셋 만들기</h3>
복제 셋에서 멤버는 50개 투표 멤버는 7개로 제한된다.
다른 멤버에 하트비트를 보내는 데 필요한 네트워크 트래픽량을 줄이고 선출에 걸리는 시간을 제한하기 위함이다.

멤버가 7개 이상인 복제 셋을 생성한다면, 모든 추가적인 멤버는 투표권이 0개여야한다.
이를 수행하려면 멤버 구성 정보에 다음처럼 명시한다.
```
> rs.add({"_id":7, "host":"server-7:27017","votes":0})
```
이는 해당 멤버들이 선출 과정에서 투표권을 행사하는 것을 방지한다.

<h3>13.2.4 재구성 강제하기</h3>
복제 셋의 과반수를 영구적으로 잃으면, 프라이머리가 없는 상태에서 설정을 재구성할 필요가 있다.
일반적으로 재구성을 프라이머리에 요청하기 떄문이다.
셸에서 세컨더리에 연결하고 "force"옵션을 이용해 재구성 명령을 전달한다.
```
> rs.reconfig(config, {"force":true})

