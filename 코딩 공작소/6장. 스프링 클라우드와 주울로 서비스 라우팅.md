<h1>6장. 스프링 클라우드와 주울로 서비스 라우팅</h1>
<ul>
  <li>6.1 서비스 게이트웨이란?</li>
  <li>6.2 스프링 클라우드와 넷플릭스 주울 소개</li>
  <li>6.3 주울에서 경로 구성</li>
  <li>6.4 주울의 진정한 힘! 필터</li>
  <li>6.5 상관관계 ID를 생성하는 주울의 사전 필터 작성</li>
  <li>6.6 상관관계 ID를 잔덜받는 사후 필터 작성</li>
  <li>6.7 동적 경로 필터 작성</li>
  <li>6.8 요약</li>
</ul>


<H3>서비스 게이트웨이 배경</H3>
마이크로서비스 같은 분산형 아키텍처에서는 여러 서비스 호출 사이에서 발생하는 보안과 로깅, 사용자 추적 등 주요 행위를 확인하는 시점이 필요.<BR/>
그 기능을 구현할 때 공통적인 프레임워크나 라이브러리를 사용해서 서비스마다 도입해야한다.<BR/>

그래서 서비스 게이트웨이는 서비스 클라이언트가 서비스를 직접 호출하지 않고 단일한 정책 시행 시점 역할을 하는 서비스 게이트웨이로 모든 호풀을 경유시켜 최종 목적지로 라우팅이 필요.<BR/>

주울은 넷플릭스의 오픈 소스 서비스 게이트웨이를 구현한 것이다.<BR/>

<H2>6.1 서비스 게이트웨이란?</H2>

![6-1](https://user-images.githubusercontent.com/87962572/153710163-ddff27b9-fcbd-4667-ba72-008e7fb739ea.PNG)

지금까지는 웹 클라이언트 개별 서비스를 직접 호출하거나 유레카 같은 서비스 디스커버리 엔진을 이용해 프로그램 방식으로 호출하였다.<BR/>

서비스 게이트웨이는 서비스 클라이언트와 호출될 서비스 사이에서 중개 역할을 한다.<BR/>
서비스 클라이언트는 서비스 게이트웨이가 관리하는 하나의 URL을 통해 통신한다.<BR/>
서비스 클라이언트 호출에서 보낸 경로를 추려 내고 서비스 클라이언트가 호출하려는 서비스를 판별한다.<BR/>

따라서 마이크로서비스 호출로 유입되는 모든 트래픽에 대해서 게이트키퍼 역할을 한다.<BR/>
서비스 게이트웨이가 구축되면 서비스 클라이언트는 개별 서비스의 URL를 직접 호출하지 않고 서비스 게이트웨이로 모든 호출을 보낸다.<BR/>

![6-2](https://user-images.githubusercontent.com/87962572/153710278-0a54e1dc-04d6-429e-a916-56bc52d3a394.PNG)

<H3>서비스 게이트웨이에서 구현할수 있는 횡단 관심사</H3>
  - 정적 라우팅 : 서비스 게이트웨이는 단일 서비스 URL과 API 경로로 모든 서비스를 호출하게 된다.<BR/>
  - 동적 라우팅 : 서비스 게이트웨이가 서비스 요청을 주사하고 데이터 기반으로 기능형 라우팅을 수행한다.<BR/>
  - 인증과 인가 : 모든 서비스 호출은 서비스 게이트웨이로 호출되므로 서비스 호출자가 자신을 인증하고 서비스를 호출한 권한 여부를 확인할 수 있다.<BR/>
  - 측정 지표 수집과 로깅 : 서비스 호출이 서비스 게이트웨이로 통과할 떄 측정 지표와 로그 정보를 수집할 수 있는 장소가 된다. (서비스 호출 횟수, 응답시간 등)<BR/>

<H2>6.2 스프링 클라우드와 넷플릭스 주울 소개</H2>
주울(Zuul)은 스프링 클라우드 애너테이션으로 설정하고, 사용하기 쉬운 서비스 게이트웨이다.<BR/>
- 애플리케이션의 모든 경로를 단일 URL로 매핑 (모든것을 그렇게 처리해야만하는 것은 아님)<BR/>
- 게이트웨이로 유입되는 요청을 검사하고 대응할 수 있는 필터 작성 <BR/>

<H3>6.2.1 주울 스프링 부트 프로젝트 설정</H3>
pom.xml에 추가

```
<dependency>
 <groupId>org.springframework.cloud</groupId>
 <artifactId>spring-cloud-starter-zuul</artifactId>
</dependency>
```

<h3>6.2.2 주울 서비스를 위한 스프링 클라우드 애너테이션</h3>
메이븐 의존성을 추가한 후 부트 스트랩 클래스에서 주울 서비스를 위한 애너테이션이 추가되어야 한다.

@EnableZuulProxy 추가

```
package com.thoughtmechanix.zuulsvr;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
@EnableZuulProxy                 -- 서비스를 주울 서버로 사용한다.
public class ZuulServerApplication {
  public static void main(String[] args) {
    SpringApplication.run(ZuulServerApplication.class, args);
  }
}
```

<h3>6.2.3 유레카와 통신하는 주울 구성</h3>
마지막으로 주울 서버의 application.yml을 수정해 유레카 서버를 가리키도록 하는 것이다.

```
eureka:
 instance:
  preferIpAddress: true
 client:
  registerWithEureka: true
  fetchRegistry: true
  serviceUrl:
    defaultZone: http://localhost:8761/eureka/
```

<h2>6.3 주울에서 경로 구성</h2>

주울은 리버스 프록시다.<BR/>
- 리버스 프록시 : 자원에 접근하려는 클라이언트와 자원 사이에 위치한 중개 서버다.<BR/>
- 클라이언트는 프록시가 아닌 다른 서버와 통신하는 것조차 알 수 없고, 리버스 프록시는 클라이언트의 요청을 받은 후 클라이언트를 대신해 원격 자원을 호출한다.<BR/>

주을이 하위 클라이언트와 통신하려면 유입되는 호출을 어떻게 하위 경로로 매핑할지 알아야 한다.<BR/>
- 서비스 디스커버리를 이용한 자동 경로 매핑<BR/>
- 서비스 디스커버리를 이용한 수동 경로 매핑<BR/>
- 정적 URL을 이용한 수동 경로 매핑<BR/>

<H3>6.3.1 서비스 디스커버리를 이용한 자동 경로 매핑</H3>

주을은 zuulsvr/src/main/resources/application.yml 경로를 정의해서 모든 경로를 매핑한다.
특별한 구성 없이도 서비스 ID를 기반으로 요청을 자동 라우팅할 수 있다.

EX) organizationservice를 호출하고 주울로 자동화된 라우팅을 사용하고자 한다면, 클라이언트가 다음 URL 엔드포인트로 주울 서비스 인스턴스를 호출하면 된다.

```
// 서비스 엔드포인트 경로 첫 부분에 호출하려는 서비스인 organizationservice를 표시
http://localhost:5555/organizationservice/v1/organizations/e254f8c-c442-4ebea82a-e2fc1d1ff78a
```

![6-3](https://user-images.githubusercontent.com/87962572/153710723-566420ed-1bdb-4b24-884d-4135b0580afe.PNG)

유레카와 주을을 함께 사용하면 호출할 수 있는 단일 엔드포인트를 제공할 뿐만 아니라 주울 수정 없이도 인스턴스를 추가하고 제거할 수 있다.
예를 들어 유레카에 새로운 서비스를 추가하면 주울은 자동으로 이 서비스 인스턴스에 라우팅하는데, 서비스 엔드포인트의 실제 물리적 위치를 유레카와 소통하고 있어 가능하다.

주울 서버가 관리하는 경로를 보고 싶다면 주울 서버에 /routes 엔드포인트로 경로에 접근할 수 있다.


